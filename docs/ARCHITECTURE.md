# Architecture Overview

## System Components

### 1. Splunk Enterprise Container (so1)

- **Image**: `splunk/splunk:latest` (configurable via `SPLUNK_IMAGE` env var)
- **Platform**: `linux/amd64`
- **Ports**:
  - `8000`: Splunk Web UI
  - `8089`: Splunk Management API / MCP Server endpoint
- **Health Status**: Uses embedded Splunk healthcheck
- **Restart Policy**: Always (auto-restart if container crashes)

### 2. Splunk Initialization Container (splunk-init)

- **Image**: `curlimages/curl:latest` (lightweight)
- **Purpose**: Runs initialization setup script after Splunk is healthy
- **Dependency**: Waits for `so1` service to be healthy
- **Restart Policy**: No (runs once and stops)
- **Script**: `scripts/setup-splunk-user.sh`

### 3. Data Persistence

#### Named Volumes

- **so1-var**: Stores Splunk variable data
  - Indexes (including `claude_logs`)
  - Logs
  - KV Store data
  
- **so1-etc**: Stores Splunk configuration files
  - User configs
  - App configurations
  - Authorization settings

#### Bind Mounts

- **Claude Logs Directory**: `~/Library/Logs/Claude/ → /var/log/claude_logs`
  - Automatically monitored and indexed into `claude_logs` index
  - Enables real-time Claude Desktop activity tracking

#### Local Files

- **compose.yml**: Docker Compose configuration
- **default.yml**: Splunk default configuration
- **tpl.env**: Template for environment variables
- **.env**: Runtime environment variables (git-ignored)

### 4. Claude Logs Index

- **Index Name**: `claude_logs`
- **Data Source**: `~/Library/Logs/Claude/` (macOS)
- **Purpose**: Capture Claude Desktop activity and errors
- **Monitoring**: Automatic via Splunk input monitor
- **Retention**: Follows Splunk default retention policies
- **Searchable**: Available immediately after indexing

### 5. Network

- **Type**: Bridge network (`splunk`)
- **Services**: so1, splunk-init
- **DNS**: Container names resolve within the network

## Initialization Flow

```text
make up
  ├─ make init (inject 1Password secrets → .env)
  ├─ docker compose up -d
  │  ├─ so1 (Splunk)
  │  │  ├─ Pull image
  │  │  ├─ Start container
  │  │  ├─ Install MCP app
  │  │  └─ Wait for health
  │  └─ splunk-init (waits for so1 healthy)
  └─ setup-splunk-user.sh (on so1 health)
     ├─ Create role: mcp_user
     ├─ Create user: dd
     └─ Generate token & update Claude config
```

## Security Architecture

### Authentication Layers

1. **Container to Container**: Network isolation via bridge network
2. **API Authentication**:
   - Admin operations: Username/password (admin user)
   - MCP operations: Bearer token (dd user)
3. **Transport Security**: HTTPS with self-signed certificates (localhost only)
4. **Credential Management**: 1Password CLI integration

### User Roles

| User | Role | Auth | Scope | Expiry |
| ---- | ---- | ---- | ----- | ------ |
| `dd` | `mcp_user` | Bearer token | MCP operations | 15 days |
| `admin` | Built-in | Password | Full admin | N/A |

### Environment Variables

Stored in `.env` (never committed):

```bash
SPLUNK_IMAGE=splunk/splunk:10.0
SPLUNK_PASSWORD=<from 1Password>
SPLUNKBASE_USER=<from 1Password>
SPLUNKBASE_PASS=<from 1Password>
TZ=Europe/Brussels
```

## Claude Desktop Integration

### Connection Flow

```text
Claude Desktop
      │
      ├─ Reads: ~/.claude_desktop_config.json
      │
      ├─ Spawns: npx mcp-remote
      │
      ├─ With args:
      │  ├─ URL: https://localhost:8089/services/mcp
      │  ├─ Bearer token: <auto-generated token>
      │  └─ Insecure mode: Accepts self-signed certs
      │
      └─ HTTPS → Splunk MCP Server
               ↓
        Processes MCP requests
```

### Token Management

- **Generation**: Automatic during `make up`
- **Storage**:
  - Splunk database (permanent)
  - `claude_desktop_config.json` (runtime)
- **Expiry**: 15 days from creation
- **Renewal**: Run `make up` again to generate new token

## Configuration Files

### compose.yml

- Docker Compose service definitions
- Volume mounts
- Network configuration
- Environment variables

### default.yml

- Splunk configuration defaults
- Mounted at `/tmp/defaults/default.yml`
- Merged with Splunk default configs

### setup-splunk-user.sh

- Creates `mcp_user` role
- Creates `dd` user
- Generates authentication token
- Configures Claude Desktop
- Dependencies: curl, jq

### Makefile

- Automation targets
- 1Password integration
- Docker command shortcuts

## Data Flow

### Splunk Startup

1. Container starts with environment variables
2. Splunk accepts license and terms
3. Splunk MCP Server app is installed
4. Splunk services start
5. Healthcheck begins

### Initialization

1. splunk-init waits for healthcheck to pass
2. Runs setup-splunk-user.sh
3. Creates role and user via REST API
4. Generates token for MCP operations
5. Updates Claude Desktop config
6. Container exits (restart: no)

### MCP Operation

1. Claude Desktop connects via mcp-remote
2. Sends request with Bearer token
3. Splunk validates token
4. MCP Server processes request
5. Response returned to Claude

## Scalability Considerations

### Current Limitations

- Single Splunk instance (no clustering)
- Local filesystem persistence
- Single MCP endpoint
- Self-signed certificates (localhost only)

### Future Enhancements

- Splunk clustering for HA
- External volume storage
- Multiple MCP endpoints
- Certificate management
- Load balancing

## Disaster Recovery

### Data Backup

```bash
# Backup volumes
docker run --rm -v so1-var:/data -v ~/backups:/backup \
  alpine tar czf /backup/so1-var.tar.gz -C /data .

docker run --rm -v so1-etc:/data -v ~/backups:/backup \
  alpine tar czf /backup/so1-etc.tar.gz -C /data .
```

### Recovery Process

1. Remove current containers: `make down`
2. Remove volumes: `docker volume rm so1-var so1-etc`
3. Restore backups to volumes
4. Start services: `make up`

## Performance Tuning

### Resource Requirements

- **Minimum**: 2 CPU cores, 4GB RAM
- **Recommended**: 4+ CPU cores, 8GB RAM
- **Optimal**: 8+ CPU cores, 16GB RAM

### Volume Performance

- Named volumes: Better performance than bind mounts
- so1-var: Heavy I/O for indexing
- so1-etc: Moderate I/O for configs

## Troubleshooting Architecture

### Container Health

- `docker compose ps`: Check service status
- `make logs`: View real-time logs
- `docker inspect <container>`: Detailed inspection

### Network Issues

- `docker network inspect splunk`: Network details
- `docker exec so1 ifconfig`: IP configuration
- `docker exec so1 curl -k https://localhost:8089`: API connectivity

### Volume Issues

- `docker volume inspect so1-var`: Volume details
- `docker volume inspect so1-etc`: Permissions check
- `docker exec so1 df -h`: Disk space usage
